<!DOCTYPE html>
<html>
  <head>
    <style>
      html {
        background: black;
      }
      video {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 58%;
        height: 58%;
        clip-path: polygon(0 0, 41% 100%, 100% 100%, 100% 41%);
        -webkit-clip-path: polygon(0 0, 41% 100%, 100% 100%, 100% 41%);
        animation-duration: 8s;
        animation-timing-function: linear;
        animation-iteration-count: infinite;
        transform-origin: 0% 0%;
        object-fit: cover;
      }

      #them {
        z-index: 1;
        position: fixed;
        width: 100vmax;
        height: 100vmax;
        top: 50%;
        left: 50%;
        margin-left: -50vmax;
        margin-top: -50vmax;
      }

      #me {
        z-index: 2;
        position: fixed;
        top: 50%;
        left: 50%;
        width: 20vmax;
        height: 20vmax;
        margin-left: -10vmax;
        margin-top: -10vmax;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 0 10vmax rgba(0,0,0,0.5);
      }

      #them video:nth-child(1) {
        animation-name: spin-cw-1;
      }

      #them video:nth-child(2) {
        animation-name: spin-cw-2;
      }

      #them video:nth-child(3) {
        animation-name: spin-cw-3;
      }

      #them video:nth-child(4) {
        animation-name: spin-cw-4;
      }

      #them video:nth-child(5) {
        animation-name: spin-cw-5;
      }

      #them video:nth-child(6) {
        animation-name: spin-cw-6;
      }

      #them video:nth-child(7) {
        animation-name: spin-cw-7;
      }

      #them video:nth-child(8) {
        animation-name: spin-cw-8;
      }

      #me video:nth-child(1) {
        animation-name: spin-ccw-1;
      }

      #me video:nth-child(2) {
        animation-name: spin-ccw-2;
      }

      #me video:nth-child(3) {
        animation-name: spin-ccw-3;
      }

      #me video:nth-child(4) {
        animation-name: spin-ccw-4;
      }

      #me video:nth-child(5) {
        animation-name: spin-ccw-5;
      }

      #me video:nth-child(6) {
        animation-name: spin-ccw-6;
      }

      #me video:nth-child(7) {
        animation-name: spin-ccw-7;
      }

      #me video:nth-child(8) {
        animation-name: spin-ccw-8;
      }

      @keyframes spin-cw-1 {
        0%   { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes spin-ccw-1 {
        100% { transform: rotate(0deg); }
        0% { transform: rotate(360deg); }
      }

      @keyframes spin-cw-2 {
        0% { transform: rotate(45deg) scaleX(-1); }
        100% { transform: rotate(405deg) scaleX(-1); }
      }

      @keyframes spin-ccw-2 {
        100% { transform: rotate(45deg) scaleX(-1); }
        0% { transform: rotate(405deg) scaleX(-1); }
      }

      @keyframes spin-cw-3 {
        0% { transform: rotate(90deg); }
        100% { transform: rotate(450deg); }
      }

      @keyframes spin-ccw-3 {
        100% { transform: rotate(90deg); }
        0% { transform: rotate(450deg); }
      }

      @keyframes spin-cw-4 {
        0% { transform: rotate(135deg) scaleX(-1); }
        100% { transform: rotate(495deg) scaleX(-1); }
      }

      @keyframes spin-ccw-4 {
        100% { transform: rotate(135deg) scaleX(-1); }
        0% { transform: rotate(495deg) scaleX(-1); }
      }

      @keyframes spin-cw-5 {
        0% { transform: rotate(180deg); }
        100% { transform: rotate(540deg); }
      }

      @keyframes spin-ccw-5 {
        100% { transform: rotate(180deg); }
        0% { transform: rotate(540deg); }
      }

      @keyframes spin-cw-6 {
        0% { transform: rotate(225deg) scaleX(-1); }
        100% { transform: rotate(585deg) scaleX(-1); }
      }

      @keyframes spin-ccw-6 {
        100% { transform: rotate(225deg) scaleX(-1); }
        0% { transform: rotate(585deg) scaleX(-1); }
      }

      @keyframes spin-cw-7 {
        0% { transform: rotate(270deg); }
        100% { transform: rotate(630deg); }
      }

      @keyframes spin-ccw-7 {
        100% { transform: rotate(270deg); }
        0% { transform: rotate(630deg); }
      }

      @keyframes spin-cw-8 {
        0% { transform: rotate(315deg) scaleX(-1); }
        100% { transform: rotate(675deg) scaleX(-1); }
      }

      @keyframes spin-ccw-8 {
        100% { transform: rotate(315deg) scaleX(-1); }
        0% { transform: rotate(675deg) scaleX(-1); }
      }
    </style>
  </head>
  <body>
    <div id="them">
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
    </div>
    <div id="me">
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
        <video></video>
    </div>
  </body>

  <!-- Firebase -->
  <script src="/__/firebase/5.5.6/firebase-app.js"></script>
  <script src="/__/firebase/5.5.6/firebase-auth.js"></script>
  <script src="/__/firebase/5.5.6/firebase-database.js"></script>
  <script src="/__/firebase/5.5.6/firebase-functions.js"></script>
  <script src="/__/firebase/init.js"></script>

  <script src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
  <script>
    (async () => {

      const signIn =
      () => new Promise((resolve, reject) => {
        const auth = firebase.auth();
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          if (user) {
            resolve(user);
            unsubscribe();
          } else {
            try {
              await firebase.auth().signInAnonymously();
            } catch (error) {
              reject(error);
            }
          }
        });
      });

      function showVideo(parentSelector, stream) {
        const videoElements = document.querySelectorAll(parentSelector + ' video');
        videoElements.forEach(videoElement => {
          videoElement.srcObject = stream;
          videoElement.play();
        });
      }

      const createWebRTCPeer =
      () => new Promise((resolve, reject) => {
        const peer = new Peer({key: '0e5fd0c0-9cb3-42e3-a171-1bda6fe3b9f9'});
        peer.on('error', reject);
        peer.on('open', () => resolve(peer));
        peer.on('call', call => {
          call.on('stream', () => showVideo('#them', call.remoteStream));
          call.answer();
        });
        peer.on('WebRTC error', e => console.log(e));
      });

      async function unregisterConnectionOnDisconnect(uid) {
        const database = firebase.database();
        const connectionRef = database.ref('/connection').child(uid);

        database.ref('.info/connected').on('value', async (snapshot) => {
          if (!snapshot.val()) return;
          await connectionRef.onDisconnect().remove();
        });
      }

      function registerConnection(uid, peerId) {
        const database = firebase.database();
        const connectionRef = database.ref('/connection').child(uid);
        return connectionRef.set({peerId});
      }

      async function getRemoteUid() {
        const remoteConnection = await firebase.functions().httpsCallable('requestConnection')();
        return remoteConnection.data;
      }

      async function getPeerId(uid) {
        const database = firebase.database();
        const snapshot = await database.ref('/connection').child(uid).once('value');
        return snapshot.val().peerId;
      }

      const whenDisconnected = (uid) => new Promise(resolve => {
        const database = firebase.database();
        const remoteConnectionRef = database.ref('/connection').child(uid);
        const valueCallback = remoteConnectionRef.on(
          'value',
          snapshot => {
            if (!snapshot.exists()) {
              resolve();
              remoteConnectionRef.off('value', valueCallback);
            }
          },
          error => {
            resolve();
            remoteConnectionRef.off('value', valueCallback);
          }
        );
      });

      const user = await signIn();
      const peer = await createWebRTCPeer();
      const myVideoStream = await navigator.mediaDevices.getUserMedia({video: true});
      showVideo('#me', myVideoStream);
      await unregisterConnectionOnDisconnect(user.uid);
      let shouldRegisterNewConnection = true;

      while (true) {
        try {
          if (shouldRegisterNewConnection) {
            await registerConnection(user.uid, peer.id);
            shouldRegisterNewConnection = false;
          }

          const remoteUid = await getRemoteUid();
          if (!remoteUid) {
            await new Promise(resolve => setTimeout(resolve, 4000));
            continue;
          }

          const remotePeerId = await getPeerId(remoteUid);
          if (!remotePeerId) {
            await new Promise(resolve => setTimeout(resolve, 4000));
            continue;
          }

          shouldRegisterNewConnection = true;
          peer.call(remotePeerId, myVideoStream);
          await whenDisconnected(remoteUid);

          showVideo('#them', null);

        } catch (error) {

          console.error('Something went wrong. Trying again in 10s.', error);
          await new Promise(resolve => setTimeout(resolve, 10000));
          shouldRegisterNewConnection = true;
        }
      }

    })();
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-61569356-5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-61569356-5');
  </script>

</html>
